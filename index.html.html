<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Anticipatory Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #3949ab;
            --success-color: #43a047;
            --warning-color: #ff9800;
            --danger-color: #e53935;
            --light-color: #f5f7fa;
            --dark-color: #1a1a2e;
            --card-bg: #ffffff;
            --sidebar-bg: #1a237e;
            --text-light: #ffffff;
            --text-dark: #333333;
            --border-color: #e0e0e0;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--sidebar-bg), var(--primary-color));
            color: var(--text-light);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .nav-section {
            margin-bottom: 25px;
        }
        
        .nav-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 15px;
            opacity: 0.7;
            letter-spacing: 1px;
        }
        
        .nav-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        
        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .nav-item:hover, .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .control-panel {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .control-section:last-child {
            border-bottom: none;
        }
        
        .control-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }
        
        .control-title i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .slider-label {
            width: 200px;
            font-size: 0.95rem;
        }
        
        .slider-value {
            width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--accent-color);
            background-color: #f0f4ff;
            padding: 5px;
            border-radius: 4px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            margin: 0 15px;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin: 5px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button i {
            margin-right: 8px;
        }
        
        button:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:disabled {
            background-color: #b0b0b0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .chart-title i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        .chart-wrapper {
            flex: 1;
            position: relative;
        }
        
        .metrics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }
        
        .metric-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .improvement {
            color: var(--success-color);
        }
        
        .warning {
            color: var(--warning-color);
        }
        
        .danger {
            color: var(--danger-color);
        }
        
        .results-table-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th, .results-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .results-table th {
            background-color: #f5f7fa;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .results-table tr:hover {
            background-color: #f9fafb;
        }
        
        .status-message {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-success {
            background-color: rgba(67, 160, 71, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .status-error {
            background-color: rgba(229, 57, 53, 0.1);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        
        .status-info {
            background-color: rgba(57, 73, 171, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
        
        .status-message i {
            margin-right: 10px;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin: 30px 0 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h1>AI Dashboard</h1>
                <p>Advanced Anticipatory Intelligence</p>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Main</div>
                <div class="nav-item active">
                    <i>üìä</i> Dashboard
                </div>
                <div class="nav-item">
                    <i>üîç</i> Analysis
                </div>
                <div class="nav-item">
                    <i>üìà</i> Reports
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Models</div>
                <div class="nav-item">
                    <i>üß†</i> Predictive Model
                </div>
                <div class="nav-item">
                    <i>üìâ</i> Traditional Model
                </div>
                <div class="nav-item">
                    <i>üîÆ</i> Anticipatory Model
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Settings</div>
                <div class="nav-item">
                    <i>‚öôÔ∏è</i> Configuration
                </div>
                <div class="nav-item">
                    <i>üë•</i> User Management
                </div>
                <div class="nav-item">
                    <i>üîí</i> Security
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1>Advanced Anticipatory Intelligence Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar">YKh</div>
                    <div>Yaser Khorrami</div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="control-section">
                    <div class="control-title">
                        <i>üìà</i> Data Simulation Parameters
                    </div>
                    
                    <div class="slider-container">
                        <span class="slider-label">Number of Time Steps:</span>
                        <input type="range" id="timeSteps" min="50" max="500" value="200" step="10">
                        <span class="slider-value" id="timeStepsValue">200</span>
                    </div>
                    
                    <div class="slider-container">
                        <span class="slider-label">Data Noise Level:</span>
                        <input type="range" id="noiseLevel" min="0.05" max="0.3" value="0.15" step="0.01">
                        <span class="slider-value" id="noiseLevelValue">0.15</span>
                    </div>
                    
                    <div class="slider-container">
                        <span class="slider-label">Number of Threat Events:</span>
                        <input type="range" id="threatEvents" min="5" max="20" value="12" step="1">
                        <span class="slider-value" id="threatEventsValue">12</span>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-title">
                        <i>üîÆ</i> Predictive Model Parameters
                    </div>
                    
                    <div class="slider-container">
                        <span class="slider-label">Risk Detection Threshold:</span>
                        <input type="range" id="riskThreshold" min="0.4" max="0.8" value="0.6" step="0.05">
                        <span class="slider-value" id="riskThresholdValue">0.6</span>
                    </div>
                    
                    <div class="slider-container">
                        <span class="slider-label">Random Forest Model Weight:</span>
                        <input type="range" id="rfWeight" min="0.1" max="0.9" value="0.6" step="0.1">
                        <span class="slider-value" id="rfWeightValue">0.6</span>
                    </div>
                    
                    <div class="slider-container">
                        <span class="slider-label">Neural Network Model Weight:</span>
                        <span class="slider-value" id="nnWeightValue">0.4</span>
                        <input type="range" id="nnWeight" min="0.1" max="0.9" value="0.4" step="0.1" disabled>
                        <span class="slider-label">(calculated)</span>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="runSimulation">
                        <i>üöÄ</i> Run Simulation
                    </button>
                    <button id="resetSettings">
                        <i>üîÑ</i> Reset Settings
                    </button>
                    <button id="exportResults">
                        <i>üì•</i> Export Results
                    </button>
                </div>
            </div>
            
            <div id="statusMessage" class="status-message status-info">
                <i>‚ÑπÔ∏è</i> To begin, adjust the settings and click "Run Simulation".
            </div>
            
            <div class="metrics-panel" id="metricsPanel" style="display: none;">
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-title">Overall Performance Improvement (F1-Score)</div>
                    <div class="metric-value improvement" id="overallImprovement">+0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üîç</div>
                    <div class="metric-title">Early Detection Improvement</div>
                    <div class="metric-value improvement" id="earlyDetectionImprovement">+0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-title">False Alarm Reduction</div>
                    <div class="metric-value improvement" id="falseAlarmReduction">+0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-title">Detection Power Improvement (AUC-ROC)</div>
                    <div class="metric-value improvement" id="detectionPowerImprovement">+0%</div>
                </div>
            </div>
            
            <h2 class="section-title">
                <i>üìä</i> Model Performance Visualization
            </h2>
            
            <div class="dashboard">
                <div class="chart-container">
                    <div class="chart-title">
                        <i>üìâ</i> Threat Prediction Comparison Over Time
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">
                        <i>üìä</i> Performance Metrics Comparison
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">
                        <i>‚öñÔ∏è</i> Early Detection vs False Alarms
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="detectionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">
                        <i>üìà</i> ROC Curve
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="rocChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="resultsTableContainer" style="display: none;">
                <h2 class="section-title">
                    <i>üìã</i> Model Prediction Samples
                </h2>
                
                <div class="results-table-container">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Actual Value</th>
                                <th>Traditional Model</th>
                                <th>Anticipatory Model</th>
                                <th>Difference</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Table data will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initial settings
        let simulationData = null;
        let simulationResults = null;
        let simulationMetrics = null;
        
        // Charts
        let predictionChart = null;
        let performanceChart = null;
        let detectionChart = null;
        let rocChart = null;
        
        // Update slider values on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Update slider value displays
            updateSliderValues();
            
            // Set up event listeners for sliders
            document.getElementById('timeSteps').addEventListener('input', updateSliderValues);
            document.getElementById('noiseLevel').addEventListener('input', updateSliderValues);
            document.getElementById('threatEvents').addEventListener('input', updateSliderValues);
            document.getElementById('riskThreshold').addEventListener('input', updateSliderValues);
            document.getElementById('rfWeight').addEventListener('input', updateRfWeight);
            
            // Set up event listeners for buttons
            document.getElementById('runSimulation').addEventListener('click', runSimulation);
            document.getElementById('resetSettings').addEventListener('click', resetSettings);
            document.getElementById('exportResults').addEventListener('click', exportResults);
            
            // Initialize neural network weight
            updateRfWeight();
        });
        
        function updateSliderValues() {
            document.getElementById('timeStepsValue').textContent = document.getElementById('timeSteps').value;
            document.getElementById('noiseLevelValue').textContent = document.getElementById('noiseLevel').value;
            document.getElementById('threatEventsValue').textContent = document.getElementById('threatEvents').value;
            document.getElementById('riskThresholdValue').textContent = document.getElementById('riskThreshold').value;
            document.getElementById('rfWeightValue').textContent = document.getElementById('rfWeight').value;
        }
        
        function updateRfWeight() {
            const rfWeight = parseFloat(document.getElementById('rfWeight').value);
            const nnWeight = (1 - rfWeight).toFixed(1);
            document.getElementById('nnWeightValue').textContent = nnWeight;
        }
        
        function resetSettings() {
            document.getElementById('timeSteps').value = 200;
            document.getElementById('noiseLevel').value = 0.15;
            document.getElementById('threatEvents').value = 12;
            document.getElementById('riskThreshold').value = 0.6;
            document.getElementById('rfWeight').value = 0.6;
            
            updateSliderValues();
            updateRfWeight();
            
            showStatus('Settings have been reset to default values.', 'info');
        }
        
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.innerHTML = `<i>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</i> ${message}`;
            statusElement.className = 'status-message';
            
            if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            } else {
                statusElement.classList.add('status-info');
            }
        }
        
        function runSimulation() {
            showStatus('Running simulation... Please wait.', 'info');
            
            // Disable buttons during execution
            document.getElementById('runSimulation').disabled = true;
            
            // Simulate with delay to show status
            setTimeout(() => {
                try {
                    // Run simulation (using sample data here)
                    simulateDataAndModels();
                    
                    // Display results
                    displayResults();
                    
                    showStatus('Simulation completed successfully!', 'success');
                } catch (error) {
                    console.error('Error running simulation:', error);
                    showStatus('Error running simulation: ' + error.message, 'error');
                } finally {
                    // Re-enable buttons after completion
                    document.getElementById('runSimulation').disabled = false;
                }
            }, 1500);
        }
        
        function simulateDataAndModels() {
            // Get input parameters
            const timeSteps = parseInt(document.getElementById('timeSteps').value);
            const noiseLevel = parseFloat(document.getElementById('noiseLevel').value);
            const threatEvents = parseInt(document.getElementById('threatEvents').value);
            const riskThreshold = parseFloat(document.getElementById('riskThreshold').value);
            const rfWeight = parseFloat(document.getElementById('rfWeight').value);
            
            // Generate simulated data
            simulationData = generateSimulatedData(timeSteps, noiseLevel, threatEvents);
            
            // Run models
            simulationResults = runModels(simulationData, riskThreshold, rfWeight);
            
            // Evaluate results
            simulationMetrics = evaluateModelResults(simulationResults, simulationData);
        }
        
        function generateSimulatedData(nSteps, noiseLevel, nThreatEvents) {
            // Generate simulated data similar to Python code
            const data = {
                timestamp: [],
                threat_level: [],
                indicators: [],
                context_1: [],
                context_2: [],
                context_3: []
            };
            
            // Generate base data
            for (let i = 0; i < nSteps; i++) {
                data.timestamp.push(new Date(2024, 0, i + 1));
                
                // Base pattern with noise
                const basePattern = Math.sin(2 * Math.PI * i / 50);
                const seasonal = 0.3 * Math.sin(2 * Math.PI * i / 20);
                const noise = noiseLevel * (Math.random() - 0.5) * 2;
                
                // Base threat level
                let threatBase = 0.3 + 0.25 * basePattern + 0.15 * seasonal + noise;
                
                // Add random threat events
                if (i < nSteps - 8 && Math.random() < nThreatEvents / nSteps) {
                    const duration = Math.floor(Math.random() * 4) + 3; // 3-6
                    const intensity = 0.7 + 0.2 * Math.random();
                    
                    for (let j = 0; j < duration && i + j < nSteps; j++) {
                        data.threat_level[i + j] = Math.min(1, threatBase + intensity * (1 - j / duration));
                    }
                    i += duration - 1;
                } else {
                    data.threat_level[i] = Math.max(0, Math.min(1, threatBase));
                }
                
                // Generate indicators and contexts
                data.indicators.push([
                    data.threat_level[i] * 0.7 + (Math.random() - 0.5) * 0.4,
                    data.threat_level[i] * 0.7 + (Math.random() - 0.5) * 0.4,
                    data.threat_level[i] * 0.7 + (Math.random() - 0.5) * 0.4,
                    data.threat_level[i] * 0.7 + (Math.random() - 0.5) * 0.4,
                    data.threat_level[i] * 0.7 + (Math.random() - 0.5) * 0.4
                ]);
                
                data.context_1.push(0.3 + 0.4 * Math.sin(2 * Math.PI * i / 30) + noiseLevel * (Math.random() - 0.5) * 2);
                data.context_2.push(0.4 + 0.3 * Math.cos(2 * Math.PI * i / 25) + noiseLevel * (Math.random() - 0.5) * 2);
                data.context_3.push(0.5 + 0.2 * Math.sin(2 * Math.PI * i / 40) + noiseLevel * (Math.random() - 0.5) * 2);
            }
            
            return data;
        }
        
        function runModels(data, riskThreshold, rfWeight) {
            const results = {
                traditional: [],
                anticipatory: [],
                actual: data.threat_level.slice(30) // Start from point 30
            };
            
            const nnWeight = 1 - rfWeight;
            
            // Run models on data
            for (let i = 30; i < data.threat_level.length; i++) {
                // Traditional model - prediction based on historical average
                let tradPred;
                if (i > 10) {
                    const recentData = data.threat_level.slice(Math.max(0, i - 10), i);
                    tradPred = recentData.reduce((sum, val) => sum + val, 0) / recentData.length;
                } else {
                    tradPred = 0.3;
                }
                
                // Add small noise
                tradPred += (Math.random() - 0.5) * 0.1;
                tradPred = Math.max(0.1, Math.min(0.9, tradPred));
                results.traditional.push(tradPred);
                
                // Anticipatory model - combination of algorithms considering predictive indicators
                let antiPred;
                
                if (i > 20) {
                    // Extract anticipatory features
                    const features = extractAnticipatoryFeatures(data, i);
                    
                    // Prediction with weighted combination
                    const rfPred = 0.4 * features[0] + 0.3 * features[1] + 0.3 * features[2];
                    const nnPred = 0.3 * features[0] + 0.4 * features[3] + 0.3 * features[4];
                    
                    antiPred = rfWeight * rfPred + nnWeight * nnPred;
                    
                    // Adjust based on risk threshold
                    if (antiPred > riskThreshold) {
                        antiPred = Math.min(1, antiPred * 1.2);
                    }
                } else {
                    // Simpler model for limited data
                    antiPred = 0.4 * data.threat_level[i-1] + 
                               0.3 * data.context_1[i] + 
                               0.3 * data.context_2[i];
                }
                
                antiPred = Math.max(0.1, Math.min(0.9, antiPred));
                results.anticipatory.push(antiPred);
            }
            
            return results;
        }
        
        function extractAnticipatoryFeatures(data, currentIndex) {
            const features = [];
            const threatSeries = data.threat_level.slice(Math.max(0, currentIndex - 10), currentIndex);
            
            // 1. Rate of change acceleration (weak signal)
            if (threatSeries.length > 3) {
                const firstDeriv = [];
                for (let i = 1; i < threatSeries.length; i++) {
                    firstDeriv.push(threatSeries[i] - threatSeries[i-1]);
                }
                
                const secondDeriv = [];
                for (let i = 1; i < firstDeriv.length; i++) {
                    secondDeriv.push(firstDeriv[i] - firstDeriv[i-1]);
                }
                
                const recentSecondDeriv = secondDeriv.slice(-3);
                const accelFeature = recentSecondDeriv.reduce((sum, val) => sum + val, 0) / recentSecondDeriv.length;
                features.push(Math.tanh(accelFeature * 10));
            } else {
                features.push(0.0);
            }
            
            // 2. Abnormal volatility
            const recentContext = [
                data.context_1[currentIndex-1] || 0.3,
                data.context_2[currentIndex-1] || 0.4,
                data.context_3[currentIndex-1] || 0.5
            ];
            
            const meanContext = recentContext.reduce((sum, val) => sum + val, 0) / recentContext.length;
            const variance = recentContext.reduce((sum, val) => sum + Math.pow(val - meanContext, 2), 0) / recentContext.length;
            const volatility = Math.sqrt(variance);
            features.push(Math.min(1.0, volatility * 2));
            
            // 3. Trend changes
            if (threatSeries.length > 4) {
                const recentThreat = threatSeries.slice(-4);
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                
                for (let i = 0; i < recentThreat.length; i++) {
                    sumX += i;
                    sumY += recentThreat[i];
                    sumXY += i * recentThreat[i];
                    sumX2 += i * i;
                }
                
                const n = recentThreat.length;
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                features.push(Math.tanh(slope * 5));
            } else {
                features.push(0.0);
            }
            
            // 4. Weighted moving average (emphasis on recent data)
            if (threatSeries.length >= 3) {
                const weights = [0.1, 0.3, 0.6];
                const recentData = threatSeries.slice(-3);
                let weightedSum = 0;
                let weightSum = 0;
                
                for (let i = 0; i < recentData.length; i++) {
                    weightedSum += recentData[i] * weights[i];
                    weightSum += weights[i];
                }
                
                features.push(weightedSum / weightSum);
            } else {
                features.push(threatSeries.reduce((sum, val) => sum + val, 0) / threatSeries.length);
            }
            
            // 5. Normalized standard deviation
            if (threatSeries.length >= 3) {
                const recentThreat = threatSeries.slice(-3);
                const mean = recentThreat.reduce((sum, val) => sum + val, 0) / recentThreat.length;
                const variance = recentThreat.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / recentThreat.length;
                const stdDev = Math.sqrt(variance);
                features.push(Math.min(0.5, stdDev));
            } else {
                features.push(0.1);
            }
            
            return features;
        }
        
        function evaluateModelResults(results, data) {
            const metrics = {};
            const actualArray = results.actual;
            
            // Evaluate traditional model
            metrics.traditional = calculateMetrics(actualArray, results.traditional);
            
            // Evaluate anticipatory model
            metrics.anticipatory = calculateMetrics(actualArray, results.anticipatory);
            
            return metrics;
        }
        
        function calculateMetrics(actual, predicted) {
            // Convert to binary values for metric calculation
            const actualBinary = actual.map(val => val > 0.5 ? 1 : 0);
            const predictedBinary = predicted.map(val => val > 0.5 ? 1 : 0);
            
            // Calculate TP, FP, TN, FN
            let tp = 0, fp = 0, tn = 0, fn = 0;
            
            for (let i = 0; i < actualBinary.length; i++) {
                if (actualBinary[i] === 1 && predictedBinary[i] === 1) tp++;
                else if (actualBinary[i] === 0 && predictedBinary[i] === 1) fp++;
                else if (actualBinary[i] === 0 && predictedBinary[i] === 0) tn++;
                else if (actualBinary[i] === 1 && predictedBinary[i] === 0) fn++;
            }
            
            // Calculate metrics
            const precision = tp + fp > 0 ? tp / (tp + fp) : 0;
            const recall = tp + fn > 0 ? tp / (tp + fn) : 0;
            const f1Score = precision + recall > 0 ? 2 * (precision * recall) / (precision + recall) : 0;
            
            // Early detection rate (simplified)
            let earlyDetections = 0;
            let totalThreats = 0;
            
            for (let i = 0; i < actual.length; i++) {
                if (actual[i] > 0.7) {
                    totalThreats++;
                    
                    // Check for warning in previous 5 steps
                    for (let j = Math.max(0, i - 5); j < i; j++) {
                        if (predicted[j] > 0.6) {
                            earlyDetections++;
                            break;
                        }
                    }
                }
            }
            
            const earlyDetectionRate = totalThreats > 0 ? earlyDetections / totalThreats : 0;
            
            // False positive rate
            const falsePositiveRate = fp + tn > 0 ? fp / (fp + tn) : 0;
            
            // AUC-ROC (simplified calculation)
            const aucRoc = 0.5 + (recall - falsePositiveRate) / 2;
            
            return {
                precision: precision,
                recall: recall,
                f1_score: f1Score,
                auc_roc: Math.max(0, Math.min(1, aucRoc)),
                early_detection_rate: earlyDetectionRate,
                false_positive_rate: falsePositiveRate
            };
        }
        
        function displayResults() {
            // Show metrics panel
            document.getElementById('metricsPanel').style.display = 'grid';
            
            // Calculate and display improvements
            const tradF1 = simulationMetrics.traditional.f1_score;
            const antiF1 = simulationMetrics.anticipatory.f1_score;
            const improvement = tradF1 > 0 ? ((antiF1 - tradF1) / tradF1 * 100) : 0;
            
            const earlyImprovement = (simulationMetrics.anticipatory.early_detection_rate - 
                                    simulationMetrics.traditional.early_detection_rate) * 100;
            
            const fpReduction = (simulationMetrics.traditional.false_positive_rate - 
                               simulationMetrics.anticipatory.false_positive_rate) * 100;
            
            const detectionPowerImprovement = (simulationMetrics.anticipatory.auc_roc - 
                                             simulationMetrics.traditional.auc_roc) * 100;
            
            document.getElementById('overallImprovement').textContent = `${improvement >= 0 ? '+' : ''}${improvement.toFixed(1)}%`;
            document.getElementById('earlyDetectionImprovement').textContent = `${earlyImprovement >= 0 ? '+' : ''}${earlyImprovement.toFixed(1)}%`;
            document.getElementById('falseAlarmReduction').textContent = `${fpReduction >= 0 ? '+' : ''}${fpReduction.toFixed(1)}%`;
            document.getElementById('detectionPowerImprovement').textContent = `${detectionPowerImprovement >= 0 ? '+' : ''}${detectionPowerImprovement.toFixed(1)}%`;
            
            // Create charts
            createCharts();
            
            // Fill results table
            fillResultsTable();
            
            // Show results table
            document.getElementById('resultsTableContainer').style.display = 'block';
        }
        
        function createCharts() {
            // Prediction comparison chart over time
            const predictionCtx = document.getElementById('predictionChart').getContext('2d');
            
            if (predictionChart) {
                predictionChart.destroy();
            }
            
            const timePoints = Array.from({length: simulationResults.traditional.length}, (_, i) => i);
            
            predictionChart = new Chart(predictionCtx, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: [
                        {
                            label: 'Traditional Model',
                            data: simulationResults.traditional,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: 'Anticipatory Model',
                            data: simulationResults.anticipatory,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: 'Ground Truth',
                            data: simulationResults.actual,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false,
                            borderWidth: 1.5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Threat Level'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            // Performance metrics comparison chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['Precision', 'Recall', 'F1-Score'],
                    datasets: [
                        {
                            label: 'Traditional Model',
                            data: [
                                simulationMetrics.traditional.precision,
                                simulationMetrics.traditional.recall,
                                simulationMetrics.traditional.f1_score
                            ],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        },
                        {
                            label: 'Anticipatory Model',
                            data: [
                                simulationMetrics.anticipatory.precision,
                                simulationMetrics.anticipatory.recall,
                                simulationMetrics.anticipatory.f1_score
                            ],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Score'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Early detection vs false alarms chart
            const detectionCtx = document.getElementById('detectionChart').getContext('2d');
            
            if (detectionChart) {
                detectionChart.destroy();
            }
            
            detectionChart = new Chart(detectionCtx, {
                type: 'bar',
                data: {
                    labels: ['Traditional Model', 'Anticipatory Model'],
                    datasets: [
                        {
                            label: 'Early Detection Rate',
                            data: [
                                simulationMetrics.traditional.early_detection_rate,
                                simulationMetrics.anticipatory.early_detection_rate
                            ],
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        },
                        {
                            label: 'False Positive Rate',
                            data: [
                                simulationMetrics.traditional.false_positive_rate,
                                simulationMetrics.anticipatory.false_positive_rate
                            ],
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgb(255, 159, 64)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Rate'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // ROC curve chart
            const rocCtx = document.getElementById('rocChart').getContext('2d');
            
            if (rocChart) {
                rocChart.destroy();
            }
            
            // Calculate ROC points (simplified)
            const rocPoints = 10;
            const tradFpr = [];
            const tradTpr = [];
            const antiFpr = [];
            const antiTpr = [];
            
            for (let i = 0; i <= rocPoints; i++) {
                const threshold = i / rocPoints;
                
                // Calculate for traditional model
                let tradTp = 0, tradFp = 0, tradTn = 0, tradFn = 0;
                
                for (let j = 0; j < simulationResults.actual.length; j++) {
                    const actual = simulationResults.actual[j] > 0.5 ? 1 : 0;
                    const predicted = simulationResults.traditional[j] > threshold ? 1 : 0;
                    
                    if (actual === 1 && predicted === 1) tradTp++;
                    else if (actual === 0 && predicted === 1) tradFp++;
                    else if (actual === 0 && predicted === 0) tradTn++;
                    else if (actual === 1 && predicted === 0) tradFn++;
                }
                
                tradFpr.push(tradFp / (tradFp + tradTn) || 0);
                tradTpr.push(tradTp / (tradTp + tradFn) || 0);
                
                // Calculate for anticipatory model
                let antiTp = 0, antiFp = 0, antiTn = 0, antiFn = 0;
                
                for (let j = 0; j < simulationResults.actual.length; j++) {
                    const actual = simulationResults.actual[j] > 0.5 ? 1 : 0;
                    const predicted = simulationResults.anticipatory[j] > threshold ? 1 : 0;
                    
                    if (actual === 1 && predicted === 1) antiTp++;
                    else if (actual === 0 && predicted === 1) antiFp++;
                    else if (actual === 0 && predicted === 0) antiTn++;
                    else if (actual === 1 && predicted === 0) antiFn++;
                }
                
                antiFpr.push(antiFp / (antiFp + antiTn) || 0);
                antiTpr.push(antiTp / (antiTp + antiFn) || 0);
            }
            
            rocChart = new Chart(rocCtx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: `Traditional Model (AUC = ${simulationMetrics.traditional.auc_roc.toFixed(3)})`,
                            data: tradFpr.map((fpr, i) => ({x: fpr, y: tradTpr[i]})),
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: `Anticipatory Model (AUC = ${simulationMetrics.anticipatory.auc_roc.toFixed(3)})`,
                            data: antiFpr.map((fpr, i) => ({x: fpr, y: antiTpr[i]})),
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: 'Baseline',
                            data: [{x: 0, y: 0}, {x: 1, y: 1}],
                            borderColor: 'rgb(200, 200, 200)',
                            backgroundColor: 'rgba(200, 200, 200, 0.1)',
                            borderDash: [5, 5],
                            tension: 0,
                            fill: false,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            min: 0,
                            max: 1,
                            title: {
                                display: true,
                                text: 'False Positive Rate'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            title: {
                                display: true,
                                text: 'True Positive Rate'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true
                        }
                    }
                }
            });
        }
        
        function fillResultsTable() {
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            
            const sampleSize = Math.min(10, simulationResults.traditional.length);
            
            for (let i = 0; i < sampleSize; i++) {
                const idx = simulationResults.traditional.length - sampleSize + i;
                const actualVal = simulationResults.actual[idx];
                const tradVal = simulationResults.traditional[idx];
                const antiVal = simulationResults.anticipatory[idx];
                const diff = antiVal - tradVal;
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${actualVal.toFixed(4)}</td>
                    <td>${tradVal.toFixed(4)}</td>
                    <td>${antiVal.toFixed(4)}</td>
                    <td style="color: ${diff >= 0 ? 'green' : 'red'}; font-weight: bold;">${diff >= 0 ? '+' : ''}${diff.toFixed(4)}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }
        
        function exportResults() {
            if (!simulationResults) {
                showStatus('No data available for export. Please run the simulation first.', 'error');
                return;
            }
            
            // Create CSV data
            let csvContent = "No.,Actual Value,Traditional Model,Anticipatory Model,Difference\n";
            
            for (let i = 0; i < simulationResults.traditional.length; i++) {
                const actualVal = simulationResults.actual[i];
                const tradVal = simulationResults.traditional[i];
                const antiVal = simulationResults.anticipatory[i];
                const diff = antiVal - tradVal;
                
                csvContent += `${i + 1},${actualVal.toFixed(4)},${tradVal.toFixed(4)},${antiVal.toFixed(4)},${diff.toFixed(4)}\n`;
            }
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'anticipatory_intelligence_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('Results successfully exported as CSV file.', 'success');
        }
    </script>
</body>
</html>